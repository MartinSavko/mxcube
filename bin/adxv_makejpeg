#!/usr/bin/env python

import time
import os
import sys
import gevent

adxv_cmd = "/usr/local/bin/adxv"

#cmdjpeg = adxv_cmd + " -rings -jpeg_scale 0.4 -sa %s %s"
#cmdthumb = adxv_cmd + " -rings -jpeg_scale 0.1 -sa %s %s" 

cmdjpeg = adxv_cmd + " -rings -jpeg_scale %s -sa %s %s >/dev/null 2>&1" 

def check_output_dir(filename, create=False):
    dirname = os.path.dirname(filename) 
    if not os.path.exists(dirname):
        print "Output directory %s does not exist" % dirname
        return False
    return True
     
def wait_for_inputfile(infile, timeout):
    t0 = time.time()

    while True:
        if os.path.exists(infile):
            break
        if (time.time() - t0) > timeout:
            print "Timeout waiting for input file"
            return False
        gevent.sleep(0.1)
    else:
        return True
    return True

def create_jpeg( infile, outfile, scale ):

    if not check_output_dir( outfile ):
        print "Cannot create jpeg file. Sorry"
        sys.exit(0)

    if not wait_for_inputfile( infile, timeout=+4.0 ):
        print "Giving up as input file does not seem to appear on disk"
        sys.exit(0)

    os.system(cmdjpeg % (scale, infile, outfile))
 
if __name__ == '__main__':
    inputfile = sys.argv[1]
    outputfile = sys.argv[2]
    scale = sys.argv[3]

    create_jpeg(inputfile,outputfile,scale)
